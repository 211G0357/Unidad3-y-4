<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos de Cocina</title>
    <style>
        body {
            font-family: "Poppins", sans-serif;
            background-color: #8DBCC7;
        }

        h2 {
            text-align: center;
            color: white;
            background-color: #648DB3;
            padding: 10px;
            border-radius: 8px;
            margin-top: 0;
        }

        .pedido {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pedido-fecha {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .productos-cocina {
            margin-top: 10px;
        }

        .producto {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }

        .producto-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .producto-acciones {
            display: flex;
            gap: 10px;
        }

        .estado-select {
            flex-grow: 1;
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .btn-actualizar {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

            .btn-actualizar:hover {
                background-color: #45a049;
            }

        /* Estados */
        .estado {
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }

        .estado-pendiente {
            background-color: #ffeb3b;
            color: #000;
        }

        .estado-en-preparación {
            background-color: #2196F3;
            color: white;
        }

        .estado-terminado {
            background-color: #4CAF50;
            color: white;
        }

        /* Mensajes */
        .mensaje {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }

            .mensaje.error {
                background-color: #ffebee;
                color: #c62828;
            }
    </style>
</head>
<body>
    <h2>Cocina</h2>

    <div id="contenedor-pedidos"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        const API_BASE_URL = 'https://10.1.195.177:45456/api/Cocina';
        const HUB_URL = 'https://10.1.195.177:45456/pedidosHub';

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Verificar autenticación
        if (!localStorage.getItem('token')) {
            mostrarMensaje('No estás autenticado. Redirigiendo a login...', true);
            setTimeout(() => window.location.href = '/login', 2000);
            return;
        }

        // Cargar pedidos iniciales
        await cargarPedidos();

        // Conectar a SignalR para actualizaciones en tiempo real
        await conectarSignalR();

        // Configurar listeners para los botones de actualización
        configurarEventListeners();
    } catch (error) {
        console.error('Error inicial:', error);
        mostrarMensaje('Error al iniciar la aplicación: ' + error.message, true);
    }
});

        async function cargarPedidos() {
            try {
                const response = await fetch(`${API_BASE_URL}/PedidosActivos`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const pedidos = await response.json();
                console.log('Pedidos recibidos:', pedidos); // Verifica en consola
                mostrarPedidos(pedidos);
            } catch (error) {
                console.error('Error cargando pedidos:', error);
                mostrarMensaje('Error al cargar pedidos: ' + error.message, true);
            }
        }

        function mostrarPedidos(pedidos) {
            const contenedor = document.getElementById('contenedor-pedidos');
            contenedor.innerHTML = '';

            if (!pedidos || pedidos.length === 0) {
                mostrarMensaje('No hay pedidos activos para preparar');
                return;
            }

            // Ordenar pedidos: primero los más recientes
            pedidos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            pedidos.forEach(pedido => {
                // Mostrar todos los detalles del pedido, no filtrar
                const detalles = pedido.detalles || [];

                if (detalles.length === 0) return;

                const divPedido = document.createElement('div');
                divPedido.className = 'pedido';
                divPedido.dataset.pedidoId = pedido.idPedido;

                divPedido.innerHTML = `
            <div class="pedido-header">
                <h3>Pedido #${pedido.idPedido} - Mesa ${pedido.numMesa || 'N/A'}</h3>
                <span class="estado estado-${(pedido.estado || 'Pendiente').toLowerCase().replace(' ', '-')}">
                    ${pedido.estado || 'Pendiente'}
                </span>
            </div>
            <div class="pedido-fecha">${formatearFecha(pedido.fecha)}</div>
            <div class="productos-cocina">
                ${detalles.map(detalle => `
                    <div class="producto" data-detalle-id="${detalle.idDetalle}">
                        <div class="producto-info">
                            <span>${detalle.cantidad}x ${detalle.tipoProducto} - ${detalle.producto || 'Detalle'}</span>
                            <span class="estado estado-${(detalle.estadoCocina || 'Pendiente').toLowerCase().replace(' ', '-')}">
                                ${detalle.estadoCocina || 'Pendiente'}
                            </span>
                        </div>
                        <div class="producto-acciones">
                            <select class="estado-select">
                                <option value="Pendiente" ${(detalle.estadoCocina || 'Pendiente') === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="En preparación" ${(detalle.estadoCocina || 'Pendiente') === 'En preparación' ? 'selected' : ''}>En preparación</option>
                                <option value="Terminado" ${(detalle.estadoCocina || 'Pendiente') === 'Terminado' ? 'selected' : ''}>Terminado</option>
                            </select>
                            <button class="btn-actualizar">Actualizar</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

                contenedor.appendChild(divPedido);
            });
        }
function obtenerNombreProducto(producto) {
    if (producto.producto) return producto.producto;
    if (producto.tipoProducto === 'Hamburguesa') return 'Hamburguesa';
    if (producto.tipoProducto === 'Papas') return 'Papas';
    return 'Producto';
}

        async function conectarSignalR() {
            try {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl(HUB_URL, {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets,
                        accessTokenFactory: () => localStorage.getItem('token')
                    })
                    .configureLogging(signalR.LogLevel.Information)
                    .withAutomaticReconnect([0, 2000, 10000, 30000])
                    .build();

                // Agrega estos listeners adicionales
                connection.onclose(error => {
                    console.error('Conexión cerrada:', error);
                    mostrarMensaje('Conexión perdida. Reconectando...', true);
                });

                connection.on("EstadoActualizado", (pedidoId) => {
                    console.log('EstadoActualizado recibido para pedido:', pedidoId);
                    cargarPedidos();
                });

                await connection.start();
                console.log('Conectado al hub con ID:', connection.connectionId);

                // Verifica la conexión al grupo
                await connection.invoke("AddToGroup", "Cocina")
                    .then(() => console.log('Unido al grupo Cocina'))
                    .catch(err => console.error('Error uniendo al grupo:', err));

            } catch (error) {
                console.error('Error SignalR:', error);
                mostrarMensaje('Error en conexión en tiempo real. Usando actualización manual...', true);
                setInterval(cargarPedidos, 10000); // Actualizar cada 10 segundos
            }
        }

        function configurarEventListeners() {
            document.addEventListener('click', async (e) => {
                // Verificar que el clic fue en un botón de actualización
                if (!e.target.classList.contains('btn-actualizar')) return;

                const boton = e.target;
                const productoDiv = boton.closest('.producto');

                // Validar que existen los elementos necesarios
                if (!productoDiv) {
                    mostrarMensaje('No se encontró el producto asociado', true);
                    return;
                }

                const idDetalle = parseInt(productoDiv.dataset.detalleId);
                const select = productoDiv.querySelector('.estado-select');

                if (!select) {
                    mostrarMensaje('No se encontró el selector de estado', true);
                    return;
                }

                const nuevoEstado = select.value;
                const estadoSpan = productoDiv.querySelector('.estado');

                // Validar datos
                if (isNaN(idDetalle) || idDetalle <= 0) {
                    mostrarMensaje('ID de producto inválido', true);
                    return;
                }

                if (!['Pendiente', 'En preparación', 'Terminado'].includes(nuevoEstado)) {
                    mostrarMensaje('Estado seleccionado no válido', true);
                    return;
                }

                // Configurar estado de carga
                boton.disabled = true;
                const textoOriginal = boton.textContent;
                boton.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Actualizando...
        `;

                try {
                    // Enviar datos como JSON en el body
                    const response = await fetch(`${API_BASE_URL}/ActualizarEstado`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            idDetalle: idDetalle,
                            nuevoEstado: nuevoEstado
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.message ||
                            errorData.title ||
                            `Error ${response.status}: ${response.statusText}`;
                        throw new Error(errorMsg);
                    }

                    // Actualizar UI si la respuesta fue exitosa
                    estadoSpan.textContent = nuevoEstado;
                    estadoSpan.className = `estado estado-${nuevoEstado.toLowerCase().replace(' ', '-')}`;

                    mostrarMensaje(`Estado actualizado correctamente a: ${nuevoEstado}`);

                } catch (error) {
                    console.error('Error en actualización:', {
                        error: error,
                        detalle: idDetalle,
                        estado: nuevoEstado
                    });

                    // Revertir el selector al estado anterior
                    const estadoAnterior = estadoSpan.textContent;
                    select.value = estadoAnterior;

                    mostrarMensaje(`Error al actualizar: ${error.message}`, true);
                } finally {
                    // Restaurar botón
                    boton.disabled = false;
                    boton.textContent = textoOriginal;
                }
            });
        }

function formatearFecha(fechaString) {
    if (!fechaString) return 'Fecha no disponible';
    
    try {
        const opciones = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true
        };
        return new Date(fechaString).toLocaleDateString('es-MX', opciones);
    } catch {
        return fechaString;
    }
}

function mostrarMensaje(texto, esError = false) {
    const contenedor = document.getElementById('contenedor-pedidos') || document.body;
    const mensaje = document.createElement('div');
    mensaje.className = `mensaje ${esError ? 'error' : ''}`;
    mensaje.textContent = texto;
    
    // Insertar al principio
    if (contenedor.firstChild) {
        contenedor.insertBefore(mensaje, contenedor.firstChild);
    } else {
        contenedor.appendChild(mensaje);
    }
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        if (mensaje.parentNode) {
            mensaje.remove();
        }
    }, 5000);
}
</script>

</body>
</html>