<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pedidos - Restaurante</title>
    <style>
        body {
            font-family: "Poppins", sans-serif;
            background-color: #8DBCC7;
            padding: 20px;
        }
        .mesa {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .pedido {
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* Agrega más estilos según necesites */
    </style>
</head>
<body>
    <div id="contenedor-pedidos"></div>
    <button onclick="location.href='Index.html'" style="margin-bottom: 20px;">Nuevo Pedido</button>

    <!-- 1. Carga SignalR ANTES de tu script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // 2. Espera a que todo el DOM esté cargado
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM completamente cargado");

            // 3. Verifica que el contenedor exista
            const contenedor = document.getElementById("contenedor-pedidos");
            if (!contenedor) {
                console.error("No se encontró el elemento contenedor-pedidos");
                return;
            }

            await iniciarConexionSignalR();
            await cargarPedidos();
        });

        const HUB_URL = 'https://10.1.195.177:45456/pedidosHub';
        const API_URL = 'https://10.1.195.177:45456/api/Tickets/PedidosPorMesa';
        let connection;

        async function iniciarConexionSignalR() {
            try {
                console.log("Iniciando conexión SignalR...");

                // 4. Verifica que signalR esté definido
                if (typeof signalR === 'undefined') {
                    throw new Error("SignalR no se cargó correctamente");
                }

                connection = new signalR.HubConnectionBuilder()
                    .withUrl(HUB_URL, {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets,
                        accessTokenFactory: () => localStorage.getItem("token")
                    })
                    .configureLogging(signalR.LogLevel.Warning)
                    .withAutomaticReconnect()
                    .build();

                connection.on("NuevoPedido", () => {
                    console.log("Nuevo pedido recibido");
                    cargarPedidos();
                });

                connection.on("EstadoActualizado", () => {
                    console.log("Estado actualizado recibido");
                    cargarPedidos();
                });

                await connection.start();
                console.log("Conectado a SignalR");

                await connection.invoke("AddToGroup", "Meseros");

            } catch (error) {
                console.error("Error con SignalR:", error);
                // Plan B: Actualizar cada 30 segundos
                setInterval(cargarPedidos, 30000);
            }
        }

        async function cargarPedidos() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "Login.html";
                return;
            }

            const contenedor = document.getElementById("contenedor-pedidos");
            if (!contenedor) return;

            try {
                contenedor.innerHTML = "<p>Cargando pedidos...</p>";

                const response = await fetch(API_URL, {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                if (!response.ok) throw new Error("Error al obtener pedidos");

                const pedidosPorMesa = await response.json();
                renderizarPedidos(pedidosPorMesa);

            } catch (error) {
                console.error("Error al cargar pedidos:", error);
                contenedor.innerHTML = `<p class="error">Error al cargar pedidos: ${error.message}</p>`;
            }
        }

        function renderizarPedidos(pedidosPorMesa) {
            const contenedor = document.getElementById("contenedor-pedidos");
            if (!contenedor) return;

            if (!pedidosPorMesa || pedidosPorMesa.length === 0) {
                contenedor.innerHTML = '<div class="sin-pedidos">No hay pedidos activos</div>';
                return;
            }

            let html = '';
            pedidosPorMesa.forEach(mesa => {
                html += `<div class="mesa"><h2>Mesa #${mesa.numMesa}</h2>`;

                mesa.tickets.forEach(ticket => {
                    const platillos = ticket.detalles.map(d =>
                        `${d.cantidad}x ${d.tipoProducto}`
                    ).join(", ");

                    html += `
                                <div class="pedido" onclick="IrATicket(${mesa.numMesa})">
                                    <p><strong>Mesero:</strong> ${ticket.nombreMesero}</p>
                                    <p><strong>Platillos:</strong> ${platillos}</p>
                                    <p><strong>Estado:</strong> ${ticket.estado}</p>
                                </div>
                            `;
                });

                html += '</div>';
            });

            contenedor.innerHTML = html;
        }

        function IrATicket(mesa) {
            window.location.href = `Index.html?mesa=${mesa}`;
        }
    </script>
</body>
</html>